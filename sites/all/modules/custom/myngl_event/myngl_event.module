<?php

function myngl_event_menu() {
  $items['myngl-event/%/lobby'] = array(
    'title' => 'MyNGL Lobby',
    'page callback' => 'myngl_event_lobby',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );
  
  $items['myngl-event/%/social-area'] = array(
    'title' => 'MyNGL Lobby',
    'page callback' => 'myngl_event_social_area',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );
  
  $items['myngl-event/%/ajax/message'] = array(
    'title' => 'MyNGL Lobby',
    'page callback' => 'myngl_event_social_area_ajax_message',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );

  $items['myngl-event/%/ajax/question'] = array(
    'title' => 'MyNGL Lobby',
    'page callback' => 'myngl_event_social_area_ajax_question',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );

  $items['myngl-event/%/ajax/pov_message'] = array(
    'title' => 'MyNGL Lobby',
    'page callback' => 'myngl_event_social_area_ajax_pov_message',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );
  
  $items['myngl-event/%/ajax/post-pov-message'] = array(
    'title' => 'MyNGL Lobby',
    'page callback' => 'myngl_event_social_area_ajax_post_pov_message',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );

  return $items;
}


function myngl_event_theme() {
  $items['myngl_event_lobby'] =  array(
                          'template' => 'myngl-event-lobby',
                          'variables' => array ('myngl' => NULL, 'brand' => NULL),
                        );
  
  $items['myngl_event_social_area'] =  array(
                          'template' => 'myngl-event-social-area',
                          'variables' => array ('myngl' => NULL, 'brand' => NULL, 'invitees' => NULL, 'ucg' => NULL),
                        );
  
  return $items;
}

function myngl_event_lobby($nid) {
  $myngl = node_load($nid);
  
  $brand = node_load($myngl->field_myngl_brand['und'][0]['nid']);

  return theme('myngl_event_lobby', array('myngl' => $myngl, 'brand' => $brand));
}


function myngl_event_social_area($nid) {
  drupal_add_js(path_to_theme().'/js/social-area.js');
  drupal_add_js(array('myngl_id' => $nid), 'setting');

  $myngl = node_load($nid);
  
  $brand = node_load($myngl->field_myngl_brand['und'][0]['nid']);

  $invitees = array();
  $ucg = array();  

  foreach ($myngl->field_myngl_invitees['und'] as $i) {
    $ic = array_shift(entity_load('field_collection_item', array($i['value'])));  
    $u = user_load($ic->field_invitee_user_account['und'][0]['uid']);
    $p = profile2_load_by_user($u->uid, 'profile');

    // adding lots of users to have test content to theme
    for ($x=1;$x<19;$x+=1) {
      $fb = false;
      if($x % 4 == 0) {
        $fb = true;
      }
      
      $room = false;
      if($x % 3 == 0) {
        $room = true;
      }


      $invitees[] = array (
                    'name' => $u->field_first_name['und'][0]['safe_value'] . ' ' . $u->field_last_name['und'][0]['safe_value'] . '#' .$x,
                    'pic' => theme_image_style(array('style_name' => 'user_profile_circle_image', 'path' => $p->field_picture['und'][0]['uri'], 'attributes' => array('class' => 'myngl-event-profile-pic'), 'height' => null, 'width' => null)),
                    'fb' => $fb,
                    'room' => $room,
                  );

      foreach ($ic->field_image_upload['und'] as $image) {
        $ucg[] = array( 
          'thumb' => theme_image_style(array('style_name' => 'user_generated_content_thumbs', 'path' => $image['uri'], 'attributes' => array('class' => 'myngl-event-profile-pic'), 'height' => null, 'width' => null)),
          'content' => theme_image_style(array('style_name' => 'user_generated_content_images', 'path' => $image['uri'], 'attributes' => array('class' => 'myngl-event-profile-pic'), 'height' => null, 'width' => null)),
          'user' => $u->field_first_name['und'][0]['safe_value'] . ' ' . $u->field_last_name['und'][0]['safe_value'],
        );
      }

      foreach ($ic->field_video_upload['und'] as $video) {
        $ucg[] = array (
          'thumb' => theme('youtube_thumbnail', array('image_style' => 'user_generated_content_videos', 'video_id' => $video['video_id'])),
          'content' => theme('youtube_video', array('video_id' => $video['video_id'], 'size' => 'custom', 'height' => '400px', 'width' => '600px')),
          'user' => $u->field_first_name['und'][0]['safe_value'] . ' ' . $u->field_last_name['und'][0]['safe_value'],
        );
      }
    }
  }


  return theme('myngl_event_social_area', array('myngl' => $myngl, 'brand' => $brand, 'invitees' => $invitees, 'ucg' => $ucg));
}

function myngl_event_social_area_ajax_message($nid) {
  $message['message'] = db_query('SELECT field_myngl_message_value FROM {field_data_field_myngl_message} WHERE entity_id = :eid', array(':eid' => $nid))->fetchField();
  drupal_json_output($message);
}

function myngl_event_social_area_ajax_question($nid) {
  $message['question'] = 'Question: '.db_query('SELECT field_pov_question_value FROM {field_data_field_pov_question} WHERE entity_id = :eid', array(':eid' => $nid))->fetchField();
  drupal_json_output($message);
}

function myngl_event_social_area_ajax_post_pov_message($nid) {
  $node = node_load($nid);
    
  $node->field_pov_messages['und'][] = array('value' => $_POST['pov_message']);

  node_save($node); 
}

function myngl_event_social_area_ajax_pov_message($nid) {
  $result = db_query('SELECT field_pov_messages_value FROM {field_data_field_pov_messages} WHERE entity_id = :eid ORDER BY delta DESC', array(':eid' => $nid));

  foreach ($result as $r) {
    $messages[] = $r->field_pov_messages_value;
  }

  drupal_json_output($messages);
}
