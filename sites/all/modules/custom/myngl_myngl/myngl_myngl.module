<?php

function myngl_myngl_menu() {
  $items['myngl/%/rsvp/%'] = array(
    'title' => 'Event RSVP',
    'page callback' => 'myngl_myngl_rsvp',
    'page arguments' => array(1,3),
    'access callback' => TRUE, 
  );
  
  $items['myngl/%/confirmed'] = array(
    'title' => 'RSVP CONFIRMED!',
    'page callback' => 'myngl_myngl_confirmed',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );
 
  $items['myngl/%/rsvp/complete'] = array(
    'title' => 'RSVP CONFIRMED!',
    'page callback' => 'myngl_myngl_complete',
    'page arguments' => array(1),
    'access callback' => TRUE, 
  );
  
  $items['myngl/%/change_date/%/%'] = array(
    'title' => 'RSVP CONFIRMED!',
    'page callback' => 'myngl_myngl_change_date',
    'page arguments' => array(1,3,4),
    'access callback' => TRUE, 
  );

  return $items;
}


function myngl_myngl_theme() {
  $items['myngl_confirm'] =  array(
                          'template' => 'myngl-confirm',
                          'variables' => array ('node' => null),
                        );

  $items['myngl_confirm_invite'] =  array(
                          'template' => 'myngl-confirm-invite',
                          'variables' => array ('node' => null),
                        );

  $items['panel_myngl_upcoming'] =  array(
                          'template' => 'panel-myngl-upcoming',
                          'variables' => array ('myngl' => null, 'brand' => NULL),
                        );
  
  $items['overlay_myngl_upcoming'] =  array(
                          'template' => 'overlay-myngl-upcoming',
                          'variables' => array ('myngls' => null),
                        );
  return $items;
}

function myngl_myngl_change_date($myngl_id, $user_id, $date_id) {

  $node = node_load($myngl_id);

  foreach ($node->field_myngl_invitees['und'] as $i) {
    $ic = array_shift(entity_load('field_collection_item', array($i['value'])));  

    if ($ic->field_invitee_user_account['und'][0]['uid'] == $user_id) {
      $ic->field_invitee_rsvp_date['und'][0]['value'] = $node->field_myngl_dates['und'][$date_id]['value'];
      $ic->save();
    }
  }

  print  date('m.d.Y @ g:i a',strtotime($node->field_myngl_dates['und'][$date_id]['value'])) . ' EST';
}

function myngl_myngl_rsvp($nid, $email) {
  $cookie['rsvp'] = $nid;
  user_cookie_save($cookie);

  $node = node_load($nid);

  $output = theme('myngl_confirm', array('node' => $node));

  return $output;
}

function myngl_myngl_confirmed($nid) {
  $node = node_load($nid);

  $output = theme('myngl_confirm_invite', array('node' => $node));

  return $output;
}

function myngl_myngl_brand_logo($nid) {
  $node = node_load($nid);
  
  $brand = node_load($node->field_myngl_brand['und'][0]['nid']);

  $image = theme_image_style(array('style_name' => 'brand_logo', 'path' => $brand->field_brand_logo['und'][0]['uri'], 'height' => null, 'width' => null));

  return $image;
}

function myngl_myngl_complete($nid) {
    global $user;
    $email = $user->mail;
    $myngl_node = node_load($nid);

    foreach ($myngl_node->field_myngl_invitees['und'] as $i) {
      $u = array_shift(entity_load('field_collection_item', array($i['value'])));

      if ($u->field_invitee_email_address['und'][0]['safe_value'] == $email) {
        $u->field_invitee_status['und'][0]['value'] = 'RSVP';

        if (isset($_COOKIE['Drupal_visitor_rsvp_date'])) { 
          $u->field_invitee_rsvp_date['und'][0]['value'] = $_COOKIE['Drupal_visitor_rsvp_date'];
        } else {
          $u->field_invitee_rsvp_date['und'][0]['value'] = $myngl_node->field_myngl_dates['und'][0]['value'];
        }

        $u->field_invitee_user_account['und'][0]['uid'] = $account->uid;
        $u->save(TRUE);

        user_cookie_delete('rsvp');

        drupal_goto("myngl/$nid/confirmed");        
      }
    }

    return 'Invitation Not Found';
}

function myngl_myngl_upcoming($uid) {
  $invitee_id = db_query("SELECT entity_id FROM {field_data_field_invitee_user_account} WHERE field_invitee_user_account_uid = :uid LIMIT 1", array(':uid' => $uid))->fetchField();

  if ($invitee_id != '') {
    //TODO: make sure this is getting the next scheduled myngl
    $myngl_id = db_query("SELECT entity_id FROM {field_data_field_myngl_invitees} WHERE field_myngl_invitees_value = $invitee_id LIMIT 1")->fetchField();
  }

  if (isset($myngl_id)) {
    $node = node_load($myngl_id);
    
    $brand = node_load($node->field_myngl_brand['und'][0]['nid']);

    $output = theme('panel_myngl_upcoming', array('myngl' => $node, 'brand' => $brand));

    return $output;
  } else {
    return 'No Upcoming Myngls'; 
  }

}

function myngl_myngl_upcoming_overlay($uid) {
  //find myngls for this user
  $result = db_query("SELECT entity_id FROM {field_data_field_invitee_user_account} WHERE field_invitee_user_account_uid = :uid", array(':uid' => $uid));

  $myngls = array();
  foreach ($result as $r) {
    // based on invitee id get myngls
    $sub_result = db_query("SELECT entity_id FROM {field_data_field_myngl_invitees} WHERE field_myngl_invitees_value = :iid", array(':iid' => $r->entity_id));
 
    $invitee_collection = array_shift(entity_load('field_collection_item', array($r->entity_id)));  
  
    foreach ($sub_result as $s) {
      $myngl = node_load($s->entity_id);

      $myngl_brand = array();
      $myngl_brand = array(
        'myngl' => $myngl,
        'date' => $invitee_collection->field_invitee_rsvp_date['und'][0]['value'], 
        'brand' => node_load($myngl->field_myngl_brand['und'][0]['nid']),
      );

      $myngls[] = $myngl_brand;
    }
  }    

  $output = theme('overlay_myngl_upcoming', array('myngls' => $myngls));

  return $output;
}
