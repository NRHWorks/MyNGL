<?php

function myngl_user_init() {
  global $user;

  if (($user->uid == 0) && (arg(0) != 'user') && (!(arg(0) == 'myngl' && arg(2) == 'rsvp'))) {
    if (!drupal_is_cli()) { //add to fix Drush bug
      drupal_goto('user');
    }
  }
}

function myngl_user_user_login(&$edit, $account) {
  if (isset($_COOKIE['Drupal_visitor_rsvp'])) {
    $myngl_nid = htmlspecialchars($_COOKIE['Drupal_visitor_rsvp']);
  }

  if (isset($myngl_nid)) {
    $email = $account->mail;
    $myngl_node = node_load($myngl_nid);

    foreach ($myngl_node->field_myngl_invitees['und'] as $i) {
      $u = array_shift(entity_load('field_collection_item', array($i['value'])));

      if ($u->field_invitee_email_address['und'][0]['safe_value'] == $email) {
        $u->field_invitee_status['und'][0]['value'] = 'RSVP';
        $u->field_invitee_rsvp_date['und'][0]['value'] = $myngl_node->field_myngl_dates['und'][0]['value'];
        $u->field_invitee_user_account['und'][0]['uid'] = $account->uid;
        $u->save(TRUE);

        user_cookie_delete('rsvp');

        drupal_goto("myngl/$myngl_nid/confirmed");        
      }
    }
  } 

  global $user;
  if (in_array('administrator', $user->roles)) {
    drupal_goto('admin');
  }
}

function myngl_user_form_alter(&$form, &$form_state, $form_id) {
  switch($form_id) {
    case 'user_login' :
      $form['name']['#description'] = '';
      
      $form['pass']['#description'] = '';

      $form['facebook_signin'] = array (
        '#markup' => '<div id="registration-facebook">
                        <p class="form-button-text">Facebook user?<br><br>Sign in with<br><span>FACEBOOK CONNECT</span></p>
                        <span class="fa-stack fa-lg" id="facebook-signin">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                        </span>
                      </div>',
        '#weight' => -20
      );
      $form['create_account'] = array (
        '#markup' => '<a href="/user/register" id="create-account" class="form-button"> NEW ACCOUNT</a>',
        '#weight' => 900
      );
      $form['forgot_password'] = array (
        '#markup' => '<a href="/user/password" id="forgot-password">Forgot Password?</a>',
        '#weight' => 1000
      );
      break;
  
    case 'user_pass' :
      $form['message'] = array (
      '#markup' => '<p>Forgot your password for theMyngl?  No problem. Enter your<br /> Email address and weâ€™ll send it to you.  </p>',
        '#weight' => 0,
      );
      $form['cancel'] = array (
        '#markup' => '<a href="/user" id="forgot-password-cancel">Cancel</a>',
        '#weight' => 200
      );
      break;
    
    case 'user_register_form' :
      $form['actions']['submit']['#value'] = 'REGISTER';
      
      $form['facebook_signin'] = array (
        '#markup' => '<div id="registration-facebook">
                        <p class="form-button-text">Facebook user?<br><br>Sign in with<br><span>FACEBOOK CONNECT</span></p>
                        <span class="fa-stack fa-lg" id="facebook-signin">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                        </span>
                      </div>',
        '#weight' => -20
      );
      
      $form['create_account'] = array (
        '#markup' => '<div class="form-button-wrapper">
                        <p class="form-button-text">Already have an account?</p>
                        <a href="/user" id="regiser-cancel" class="form-button">LOGIN HERE</a>
                      </div>',

        '#weight' => 900
      );
      break;
    
    case 'user_profile_form' :
      $form['actions']['submit']['#value'] = 'SUBMIT CHANGES';
      
      $form['cancel'] = array (
        '#markup' => '<a href="/user" id="edit-profile-cancel">Cancel</a>',
        '#weight' => 200
      );
      break;
  }
}

function myngl_user_form_profile2_form_alter(&$form, &$form_state) {
  if ($uid = $form['#user']->uid) {
    $u = entity_metadata_wrapper('user', user_load($uid));
    $profile = profile2_load_by_user($uid, 'profile');

    if ($profile) {
      $p = entity_metadata_wrapper('profile2', $profile);
    }
  }  

  $form['profile_profile']['field_interests']['und']['#title'] = 'Let TheMyngl further personalize your experience based on your interests:';

  $form['profile_profile']['field_picture']['und'][0]['#title'] = '';

  $form['profile_profile']['field_city']['und'][0]['#prefix'] = ' <span class="profile-name">NAME: <strong>'.$u->field_first_name->value().' '.$u->field_last_name->value().'</strong></span><br />';  

  if (isset($p)) {
    $pic = $p->field_picture->value();
  }

  if (!isset($pic['uri'])) {
    $form['profile_profile']['field_picture']['und']['#prefix'] = 
      " <div id='default-image-wrapper'>" .
        theme_image_style(array('style_name' => 'user_profile_circle_image', 'path' => 'public://default-user-profile.png', 'attributes' => array('class' => 'default-profile-pic'), 'height' => null, 'width' => null)) .
      " <br /><a href='#!' class='link-small' onclick='jQuery(\"#default-image-wrapper\").hide();jQuery(\".image-widget\").show();'>Upload a profile picture</a>
        <script>jQuery(document).ready(function () { jQuery('.image-widget').hide(); });</script>
        </div>";
  }
}
